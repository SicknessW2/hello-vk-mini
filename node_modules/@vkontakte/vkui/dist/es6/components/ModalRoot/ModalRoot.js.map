{"version":3,"sources":["../../../../src/components/ModalRoot/ModalRoot.tsx"],"names":["React","Component","PropTypes","Touch","TouchRootContext","getClassName","classNames","setTransformStyle","rubber","IS_PLATFORM_ANDROID","transitionEvents","withPlatform","TYPE_CARD","TYPE_PAGE","numberInRange","number","range","rangeTranslate","Math","max","min","ModalRoot","props","event","originalEvent","preventDefault","e","state","switching","activeModal","nextModal","modalState","modalsState","type","onPageTouchMove","onCardTouchMove","onPageTouchEnd","onCardTouchEnd","target","closest","contentScrolled","clearTimeout","contentScrollStopTimeout","window","setTimeout","activeTransitions","newState","prevModal","visibleModals","animated","history","setState","triggerActiveModalClose","isBack","inited","touchDown","dragging","maskElementRef","createRef","initModalsState","modals","reduce","acc","Modal","modalProps","id","onClose","dynamicContentHeight","settlingHeight","initActiveModal","toggleDocumentScrolling","prevProps","prevState","children","requestAnimationFrame","checkPageContentHeight","console","warn","includes","splice","indexOf","push","closeActiveModal","switchPrevNext","document","activeElement","blur","enabled","documentScrolling","removeEventListener","preventTouch","passive","addEventListener","modalId","getElementById","modalElement","pickModal","querySelector","initPageModal","initCardModal","contentElement","contentHeight","firstElementChild","offsetHeight","expandable","clientHeight","innerElement","headerElement","footerElement","collapsed","translateYFrom","translateY","expandedRange","collapsedRange","hiddenRange","shiftHalf","visiblePart","headerHeight","height","parentElement","prevModalState","currentModalState","diff","Object","keys","key","length","animateTranslate","animatePageHeader","waitTransitionFinish","prevNextSwitchEndHandler","setMaskOpacity","shiftY","startT","isY","stopPropagation","expanded","touchStartTime","touchStartContentScrollTop","scrollTop","touchMovePositive","shiftYPercent","innerHeight","shiftYCurrent","touchShiftYPercent","translateYCurrent","startY","next","shiftYEndPercent","expectTranslateY","Date","now","hidden","eventHandler","eventName","transitionEndEventName","onceHandler","nextModalState","prevIsPage","prevIsCard","nextIsPage","nextIsCard","currentPercent","frameId","cancelAnimationFrame","footerHeight","factor","headerOpenPercent","headerShadow","style","opacity","toString","forceOpacity","maskAnimationFrame","current","activeModalState","platform","webviewType","onTouchMove","onTouchEnd","onScroll","onMaskClick","map","isPage","context","concat","string","node","any","oneOf"],"mappings":"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","sourcesContent":["/* eslint-disable */\n\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport Touch from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport getClassName from '../../helpers/getClassName';\nimport classNames from '../../lib/classNames';\nimport { setTransformStyle } from '../../lib/styles';\nimport { rubber } from '../../lib/touch';\nimport { IS_PLATFORM_ANDROID } from '../../lib/platform';\nimport transitionEvents from '../../lib/transitionEvents';\nimport { HasChildren, HasPlatform } from '../../types/props';\nimport withPlatform from '../../hoc/withPlatform';\n\nexport const TYPE_CARD = 'modal-card';\nexport const TYPE_PAGE = 'modal-page';\n\nfunction numberInRange(number, range) {\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number) {\n  return Math.max(0, Math.min(98, number));\n}\n\nexport interface ModalsStateEntry {\n  id: string;\n  onClose: () => {};\n  type?: 'modal-card' | 'modal-page';\n\n  settlingHeight?: number;\n  dynamicContentHeight?: boolean;\n  expandable?: boolean;\n\n  modalElement?: HTMLDivElement;\n  innerElement?: HTMLDivElement;\n  headerElement?: HTMLDivElement;\n  contentElement?: HTMLDivElement;\n  footerElement?: HTMLDivElement;\n\n  translateY?: number;\n  translateYFrom?: number;\n  translateYCurrent?: number;\n  touchStartTime?: number;\n  touchStartContentScrollTop?: number;\n  touchMovePositive?: boolean | null;\n  touchShiftYPercent?: number;\n  expanded?: boolean;\n  collapsed?: boolean;\n  hidden?: boolean;\n  contentScrolled?: boolean;\n  expandedRange?: [number, number];\n  collapsedRange?: [number, number];\n  hiddenRange?: [number, number];\n  contentScrollStopTimeout?: number;\n}\n\nexport interface ModalRootProps extends HasChildren, HasPlatform {\n  activeModal?: string;\n\n}\n\nexport interface ModalRootState {\n  activeModal?: string;\n  prevModal?: string;\n  nextModal?: string;\n  visibleModals?: string[];\n  animated?: boolean;\n  switching?: boolean;\n  history?: string[];\n  isBack?: boolean;\n  inited?: boolean;\n  touchDown?: boolean;\n  dragging?: boolean;\n}\n\nclass ModalRoot extends Component<ModalRootProps, ModalRootState> {\n  constructor(props) {\n    super(props);\n\n    const activeModal = props.activeModal;\n\n    this.state = {\n      activeModal: null,\n      prevModal: null,\n      nextModal: activeModal,\n      visibleModals: activeModal ? [activeModal] : [],\n      animated: !!activeModal,\n      switching: false,\n      history: activeModal ? [activeModal] : [],\n      isBack: false,\n      inited: false,\n      touchDown: false,\n      dragging: false,\n    };\n\n    this.activeTransitions = 0;\n    this.maskElementRef = React.createRef();\n\n    this.initModalsState();\n  }\n\n  private modalsState: { [id: string]: ModalsStateEntry };\n  private documentScrolling: boolean;\n  private activeTransitions: number;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number;\n\n  static propTypes = {\n    activeModal: PropTypes.string,\n    children: PropTypes.node,\n  };\n\n  static contextTypes = {\n    window: PropTypes.any,\n    document: PropTypes.any,\n    webviewType: PropTypes.oneOf(['vkapps', 'internal']),\n  };\n\n  get document() {\n    return this.context.document || document;\n  }\n\n  get window() {\n    return this.context.window || window;\n  }\n\n  get webviewType() {\n    return this.context.webviewType || 'vkapps';\n  }\n\n  get modals() {\n    return [].concat(this.props.children);\n  }\n\n  initModalsState() {\n    this.modalsState = this.modals.reduce((acc, Modal) => {\n      const modalProps = Modal.props;\n      const state: ModalsStateEntry = {\n        id: Modal.props.id,\n        onClose: Modal.props.onClose,\n        dynamicContentHeight: !!modalProps.dynamicContentHeight,\n      };\n\n      // ModalPage props\n      if (typeof modalProps.settlingHeight === 'number') {\n        state.settlingHeight = modalProps.settlingHeight;\n      }\n\n      acc[state.id] = state;\n      return acc;\n    }, {});\n  }\n\n  componentDidMount() {\n    this.initActiveModal();\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    const { activeModal, switching } = this.state;\n\n    if (activeModal && this.modalsState[activeModal] && !switching && this.props.children !== prevProps.children) {\n      const modalState = this.modalsState[activeModal];\n      if (modalState && modalState.type === TYPE_PAGE && modalState.dynamicContentHeight) {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n\n    if (this.props.activeModal !== prevProps.activeModal && !this.state.switching) {\n      const nextModal = this.props.activeModal;\n      const prevModal = prevProps.activeModal;\n\n      if (nextModal !== null && !this.modalsState[nextModal]) {\n        return console.warn(`[ModalRoot.componentDidUpdate] nextModal ${nextModal} not found`);\n      }\n\n      let history = [...this.state.history];\n      let isBack = false;\n\n      if (nextModal === null) {\n        history = [];\n      } else if (history.includes(nextModal)) {\n        history = history.splice(0, history.indexOf(nextModal) + 1);\n        isBack = true;\n      } else {\n        history.push(nextModal);\n      }\n\n      return this.setState({\n        activeModal: null,\n        nextModal,\n        prevModal,\n        visibleModals: [nextModal, prevModal],\n        history,\n        isBack,\n        animated: true,\n        inited: false,\n        switching: false,\n      }, () => {\n        if (nextModal === null) {\n          this.closeActiveModal();\n        } else {\n          this.initActiveModal();\n        }\n      });\n    }\n\n    if (this.state.switching && !prevState.switching) {\n      requestAnimationFrame(() => this.switchPrevNext());\n    }\n\n    if (!this.state.activeModal && !this.state.prevModal && !this.state.nextModal) {\n      this.toggleDocumentScrolling(true);\n    } else {\n      this.toggleDocumentScrolling(false);\n    }\n  }\n\n  blurActiveElement() {\n    if (typeof this.window !== 'undefined' && this.document.activeElement) {\n      this.document.activeElement.blur();\n    }\n  }\n\n  /**\n   * Отключает скролл документа\n   */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // Здесь нужен последний аргумент с такими же параметрами, потому что\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      this.window.removeEventListener('touchmove', this.preventTouch, { passive: false });\n    } else {\n      this.window.addEventListener('touchmove', this.preventTouch, { passive: false });\n    }\n  }\n\n  preventTouch = (event) => {\n    if (event) {\n      while (event.originalEvent) {\n        event = event.originalEvent;\n      }\n      event.preventDefault();\n    }\n  };\n\n  pickModal(modalId) {\n    return this.document.getElementById('modal-' + modalId);\n  }\n\n  /**\n   * Инициализирует модалку перед анимацией открытия\n   */\n  initActiveModal() {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalElement = this.pickModal(activeModal);\n    const modalState = this.modalsState[activeModal];\n\n    if (modalElement.querySelector('.ModalPage')) {\n      modalState.type = TYPE_PAGE;\n    } else if (modalElement.querySelector('.ModalCard')) {\n      modalState.type = TYPE_CARD;\n    }\n\n    switch (modalState.type) {\n      case TYPE_PAGE:\n        modalState.settlingHeight = modalState.settlingHeight || 75;\n        this.initPageModal(modalState, modalElement);\n        break;\n\n      case TYPE_CARD:\n        this.initCardModal(modalState, modalElement);\n        break;\n\n      default:\n        console.warn('[ModalRoot.initActiveModal] modalState.type is unknown');\n    }\n\n    this.setState({ inited: true, switching: true });\n  }\n\n  initPageModal(modalState: ModalsStateEntry, modalElement: HTMLDivElement) {\n    const contentElement: HTMLElement = modalElement.querySelector('.ModalPage__content');\n    const contentHeight = (contentElement.firstElementChild as HTMLElement).offsetHeight;\n\n    modalState.expandable = contentHeight > contentElement.clientHeight;\n\n    modalState.modalElement = modalElement;\n    modalState.innerElement = modalElement.querySelector('.ModalPage__in-wrap');\n    modalState.headerElement = modalElement.querySelector('.ModalPage__header');\n    modalState.contentElement = modalElement.querySelector('.ModalPage__content');\n    modalState.footerElement = modalElement.querySelector('.ModalPage__footer');\n\n    let collapsed;\n    let translateYFrom;\n    let translateY;\n    let expandedRange;\n    let collapsedRange;\n    let hiddenRange;\n\n    if (modalState.expandable) {\n      translateYFrom = 100 - modalState.settlingHeight;\n\n      const shiftHalf = translateYFrom / 2;\n      const visiblePart = 100 - translateYFrom;\n\n      expandedRange = [0, shiftHalf];\n      collapsedRange = [shiftHalf, translateYFrom + visiblePart / 4];\n      hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n      collapsed = true;\n      translateY = translateYFrom;\n    } else {\n      const headerHeight = modalState.headerElement.offsetHeight;\n      const height = contentHeight + headerHeight;\n\n      translateYFrom = 100 - height / modalState.innerElement.parentElement.offsetHeight * 100;\n      translateY = translateYFrom;\n\n      expandedRange = [translateY, translateY + 25];\n      collapsedRange = [translateY + 25, translateY + 25];\n      hiddenRange = [translateY + 25, translateY + 100];\n\n      collapsed = false;\n    }\n\n    modalState.expandedRange = expandedRange;\n    modalState.collapsedRange = collapsedRange;\n    modalState.hiddenRange = hiddenRange;\n    modalState.translateY = translateY;\n    modalState.translateYFrom = translateYFrom;\n    modalState.collapsed = collapsed;\n  }\n\n  initCardModal(modalState: ModalsStateEntry, modalElement: HTMLDivElement) {\n    modalState.modalElement = modalElement;\n    modalState.innerElement = modalElement.querySelector('.ModalCard__in');\n\n    modalState.translateY = 0;\n  }\n\n  checkPageContentHeight() {\n    const activeModal = this.state.activeModal;\n\n    const modalElement = this.pickModal(activeModal);\n    if (modalElement) {\n      const modalState = this.modalsState[activeModal];\n\n      const prevModalState = { ...modalState };\n      this.initPageModal(modalState, modalElement);\n      const currentModalState = { ...modalState };\n\n      const diff = Object.keys(currentModalState).reduce((acc, key) => {\n        if (prevModalState[key] !== currentModalState[key]) {\n          acc[key] = currentModalState[key];\n        }\n\n        return acc;\n      }, {});\n\n      if (Object.keys(diff).length) {\n        this.animateTranslate(modalState);\n        this.animatePageHeader(modalState);\n      }\n    }\n  }\n\n  closeActiveModal() {\n    const { prevModal } = this.state;\n    if (!prevModal) {\n      return console.warn(`[ModalRoot.closeActiveModal] prevModal is ${prevModal}`);\n    }\n\n    const prevModalState = this.modalsState[prevModal];\n\n    this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(prevModalState, 100);\n    this.setMaskOpacity(prevModalState, 0);\n  }\n\n  onTouchMove = (e) => {\n    if (this.state.switching) {\n      return;\n    }\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === TYPE_PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === TYPE_CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event, modalState: ModalsStateEntry) {\n    const { shiftY, startT, originalEvent } = event;\n\n    if (!event.isY) {\n      if (originalEvent.target.closest('.ModalPage')) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!originalEvent.target.closest('.ModalPage__in')) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartTime = startT;\n      modalState.touchStartContentScrollTop = modalState.contentElement.scrollTop;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 ||\n      originalEvent.target.closest('.ModalPage__header')\n    ) {\n      originalEvent.preventDefault();\n      if (!expandable && shiftY < 0) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = shiftY / this.window.innerHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, IS_PLATFORM_ANDROID);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate(modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY, startT } = event;\n    if (originalEvent.target.closest('.ModalCard__container')) {\n      if (!this.state.touchDown) {\n        modalState.touchStartTime = startT;\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, IS_PLATFORM_ANDROID);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e) => {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === TYPE_PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState.type === TYPE_CARD) {\n      return this.onCardTouchEnd(modalState);\n    }\n  };\n\n  onPageTouchEnd(event, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let next;\n\n    if (this.state.dragging) {\n      const shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n\n      let translateY = modalState.translateYCurrent;\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (numberInRange(translateY, modalState.expandedRange)) {\n        translateY = modalState.expandedRange[0];\n      } else if (numberInRange(translateY, modalState.collapsedRange)) {\n        translateY = modalState.translateYFrom;\n      } else if (numberInRange(translateY, modalState.hiddenRange)) {\n        translateY = 100;\n      } else {\n        translateY = modalState.translateYFrom;\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = translateY > 0 && translateY < shiftYEndPercent;\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        modalState.onClose();\n      }\n\n      next = () => {\n        !modalState.hidden && this.animateTranslate(modalState);\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, next);\n  }\n\n  onCardTouchEnd(modalState: ModalsStateEntry) {\n    let next;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent;\n\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        modalState.onClose();\n      }\n\n      next = () => {\n        !modalState.hidden && this.animateTranslate(modalState);\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, next);\n  }\n\n  onScroll = (e) => {\n    const activeModal = this.state.activeModal;\n\n    if (activeModal && e.target.closest('.ModalPage__content')) {\n      const modalState = this.modalsState[activeModal];\n      modalState.contentScrolled = true;\n\n      clearTimeout(modalState.contentScrollStopTimeout);\n\n      modalState.contentScrollStopTimeout = window.setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry, eventHandler: () => void) {\n    const eventName = transitionEvents.transitionEndEventName;\n\n    const onceHandler = () => {\n      modalState.innerElement.removeEventListener(eventName, onceHandler);\n      eventHandler();\n    };\n\n    modalState.innerElement.addEventListener(eventName, onceHandler);\n  }\n\n  switchPrevNext() {\n    const { prevModal, nextModal } = this.state;\n\n    const prevModalState = this.modalsState[prevModal];\n    const nextModalState = this.modalsState[nextModal];\n\n    if (!prevModalState && !nextModalState) {\n      return console.warn(`[ModalRoot.switchPrevNext] prevModal is ${prevModal}, nextModal is ${nextModal}`);\n    }\n\n    const prevIsPage = !!prevModalState && prevModalState.type === TYPE_PAGE;\n    const prevIsCard = !!prevModalState && prevModalState.type === TYPE_CARD;\n\n    const nextIsPage = !!nextModalState && nextModalState.type === TYPE_PAGE;\n    const nextIsCard = !!nextModalState && nextModalState.type === TYPE_CARD;\n\n    // Ждём полного скрытия предыдущей модалки\n    if (prevModalState && (nextIsCard || prevIsCard && nextIsPage)) {\n      this.waitTransitionFinish(prevModalState, () => {\n        this.activeTransitions += 1;\n        this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n        this.animateTranslate(nextModalState);\n      });\n\n      return this.animateTranslate(prevModalState, 100);\n    }\n\n    if (prevModalState && nextIsPage) {\n      this.activeTransitions += 1;\n      this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n\n      if (prevIsPage && prevModalState.translateY <= nextModalState.translateYFrom && !this.state.isBack) {\n        this.animateTranslate(prevModalState, nextModalState.translateYFrom + 10);\n      } else {\n        this.animateTranslate(prevModalState, 100);\n      }\n    }\n\n    this.activeTransitions += 1;\n    this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(nextModalState);\n  }\n\n  prevNextSwitchEndHandler = () => {\n    this.activeTransitions = Math.max(0, this.activeTransitions - 1);\n    if (this.activeTransitions > 0) {\n      return;\n    }\n\n    const activeModal = this.state.nextModal;\n\n    const newState: ModalRootState = {\n      prevModal: null,\n      nextModal: null,\n      visibleModals: [activeModal],\n      activeModal: activeModal,\n      animated: false,\n      switching: false,\n    };\n\n    if (!activeModal) {\n      newState.history = [];\n    }\n\n    this.setState(newState);\n  };\n\n  /**\n   * Анимирует сдивг модалки\n   */\n  animateTranslate(modalState: ModalsStateEntry, currentPercent: number = null) {\n    if (currentPercent === null) {\n      currentPercent = modalState.translateY;\n    }\n\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this[frameId]);\n    this[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translateY(${currentPercent}%)`);\n\n      if (modalState.type === TYPE_PAGE && modalState.footerElement) {\n        const footerHeight = modalState.footerElement.offsetHeight;\n        const factor = modalState.innerElement.offsetHeight * (currentPercent / 100);\n\n        setTransformStyle(modalState.footerElement, `translateY(calc(${footerHeight}px * -${factor / footerHeight}))`);\n      }\n    });\n\n    if (modalState.type === TYPE_PAGE && modalState.expandable) {\n      this.animatePageHeader(modalState, currentPercent);\n    }\n  }\n\n  /**\n   * Анимирует тень шапки\n   */\n  animatePageHeader(modalState: ModalsStateEntry, currentPercent: number = null) {\n    if (currentPercent === null) {\n      currentPercent = modalState.translateY;\n    }\n    const headerOpenPercent = currentPercent < 15 ? Math.max(0, 15 - currentPercent) / 15 : 0;\n\n    requestAnimationFrame(() => {\n      const headerShadow: HTMLElement = modalState.headerElement.querySelector('.ModalPageHeader__shadow');\n      if (headerShadow) {\n        headerShadow.style.opacity = headerOpenPercent.toString();\n      }\n    });\n  }\n\n  /**\n   * Устанавливает прозрачность для полупрозрачной подложки\n   */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number = null) {\n    if (forceOpacity === null && this.state.history[0] !== modalState.id) {\n      return;\n    }\n\n    cancelAnimationFrame(this.maskAnimationFrame);\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY, translateYCurrent } = modalState;\n\n        const opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(0, Math.min(100, opacity)).toString();\n      }\n    });\n  }\n\n  /**\n   * Закрывает текущую модалку\n   */\n  triggerActiveModalClose() {\n    const activeModalState = this.modalsState[this.state.activeModal];\n    if (activeModalState) {\n      activeModalState.onClose();\n    }\n  }\n\n  /**\n   * По клику на полупрозрачный черный фон нужно закрыть текущую модалку\n   */\n  onMaskClick = () => {\n    if (!this.state.switching) {\n      this.triggerActiveModalClose();\n    }\n  };\n\n  render() {\n    const { prevModal, activeModal, nextModal, visibleModals, animated, touchDown, dragging, switching } = this.state;\n\n    if (!activeModal && !prevModal && !nextModal && !animated) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <Touch\n          className={classNames(getClassName('ModalRoot', this.props.platform), {\n            'ModalRoot--vkapps': this.webviewType === 'vkapps',\n            'ModalRoot--touched': touchDown,\n            'ModalRoot--switching': switching,\n          })}\n          onMove={this.onTouchMove}\n          onEnd={this.onTouchEnd}\n          onScroll={this.onScroll}\n        >\n          <div\n            className=\"ModalRoot__mask\"\n            onClick={this.onMaskClick}\n            ref={this.maskElementRef}\n          />\n          <div className=\"ModalRoot__viewport\">\n            {this.modals.map((Modal) => {\n              const modalId = Modal.props.id;\n              if (!visibleModals.includes(Modal.props.id)) {\n                return null;\n              }\n              const modalState = this.modalsState[modalId];\n\n              const isPage = modalState.type === TYPE_PAGE;\n              const key = 'modal-' + modalId;\n\n              return (\n                <div\n                  key={key}\n                  id={key}\n                  className={classNames('ModalRoot__modal', {\n                    'ModalRoot__modal--active': modalId === activeModal,\n                    'ModalRoot__modal--prev': modalId === prevModal,\n                    'ModalRoot__modal--next': modalId === nextModal,\n\n                    'ModalRoot__modal--dragging': dragging,\n\n                    'ModalRoot__modal--expandable': isPage && modalState.expandable,\n                    'ModalRoot__modal--expanded': isPage && modalState.expanded,\n                    'ModalRoot__modal--collapsed': isPage && modalState.collapsed,\n                  })}\n                >{Modal}</div>\n              );\n            })}\n          </div>\n        </Touch>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport default withPlatform(ModalRoot);\n"],"file":"ModalRoot.js"}